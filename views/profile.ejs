<!DOCTYPE html>
<html lang="en">
<%- include("./partials/head.ejs") %>

<body>
  <%- include("./partials/nav.ejs") %>

  <div class="dashboard-container container-fluid py-5">
    <div class="row">

      <!-- Leva kolona -->
      <div class="col-lg-3 mb-4">
        <div class="dashboard-card p-3 mb-3">
          <div class="dashboard-user mb-3">
            <i class="fas fa-user me-2"></i>
            <span>Korisnik: <strong><%= user.username %></strong></span>
          </div>

          <div class="dashboard-balance-highlight mb-3">
            <i class="fas fa-wallet me-2"></i>
            Balans: <span><%= user.balance %> $</span>
          </div>

          <form action="/logout" method="GET" class="dashboard-logout">
            <button type="submit">
              <i class="fas fa-sign-out-alt me-1"></i> Izloguj se
            </button>
          </form>
          <div id="errorBalance" class="text-danger text-center mt-2">
            <%= error %>
          </div>
        </div>

        <div class="dashboard-card p-3">
          <form action="/changebalance" method="POST" class="dashboard-page__change-balance mb-2">
            <input id="balans" name="balans" step="0.01" type="number" placeholder="Iznos" class="form-control mb-2" required>
            <button type="submit" class="btn-create-goal w-100">
              <i class="fas fa-plus-circle me-1"></i> Dodaj novac
            </button>
          </form>
        </div>
      </div>

      <!-- Srednja kolona -->
      <div class="col-lg-5">
        <div class="dashboard-single-goal p-3 bg-dark text-light rounded shadow-sm mb-3">
          <div class="dashboard-goal-info d-flex justify-content-between mb-2">
            <strong><i class="fas fa-bullseye me-2"></i> Dnevni cilj</strong>
            <span><%= user.daily_saved %> / <%= user.daily_goal %> $</span>
          </div>
          <div class="progress mb-2" style="height: 10px;">
            <div class="progress-bar bg-success" role="progressbar"
                 style="width:<%= Math.min((user.daily_saved / user.daily_goal) * 100, 100) %>%"></div>
          </div>
          <form action="/changedailygoal" method="POST" class="dashboard-page__change-balance mb-2">
            <input id="dailyGoal" name="dailyGoal" step="0.01" type="number" placeholder="Iznos" class="form-control mb-2" required>
            <p id="recommendedSavings" class="text-muted small mb-2"></p>
            <button type="submit" class="btn-create-goal w-100">
              <i class="fas fa-plus-circle me-1"></i> Promeni dnevni cilj
            </button>
          </form>
        </div>

        <h2 class="mb-3">Tvoji ciljevi:</h2>
        <div class="row">
          <% if (goals.length > 0) { %>
            <% goals.forEach(goal => { %>
              <div class="col-md-12 mb-3">
                <div class="dashboard-single-goal p-3 bg-dark text-light rounded shadow-sm">
                  <div class="dashboard-goal-info d-flex justify-content-between mb-2">
                    <strong><i class="fas fa-bullseye me-2"></i><%= goal.name %></strong>
                    <span><%= goal.current %> / <%= goal.target %> $</span>
                  </div>
                  <div class="progress mb-2" style="height: 10px;">
                    <div class="progress-bar bg-success" role="progressbar"
                         style="width:<%= Math.min((goal.current / goal.target) * 100, 100) %>%"></div>
                  </div>
                  <form action="/addgoalbalance" method="POST" class="dashboard-goal__form mb-2">
                    <input name="goalbalance" step="0.01" type="number" placeholder="Iznos" class="form-control mb-2" required>
                    <input type="hidden" name="goalId" value="<%= goal.id %>">
                    <button type="submit" class="btn-create-goal w-100">
                      <i class="fas fa-plus me-1"></i> Dodaj novac
                    </button>
                  </form>
                </div>
              </div>
            <% }) %>
          <% } else { %>
            <p>Nemaš nijedan cilj trenutno.</p>
          <% } %>
        </div>

        <form action="/newgoals" method="GET" class="mt-3">
          <button type="submit" class="btn-create-goal w-100">
            <i class="fas fa-flag me-1"></i> Kreiraj novi cilj
          </button>
        </form>
      </div>

      <!-- Desna kolona -->
      <div class="col-lg-4">
        <div class="dashboard-card p-3 mb-3">
          <h3 class="mb-3">Mesečni prihod</h3>
          <form id="monthlyIncomeForm" class="mb-3">
            <input id="monthlyIncome" type="number" step="0.01" placeholder="Unesi svoj prosečni mesečni prihod" class="form-control mb-2">
            <button type="submit" class="btn-create-goal w-100">
              <i class="fas fa-calculator me-1"></i> Potvrdi
            </button>
          </form>
        </div>

        <div class="dashboard-card p-3 mb-3">
          <h3 class="mb-3">Mesecni rashodi</h3>
          <ul id="expensesList" class="list-group mb-3">
            <% if(expenses.length > 0) { %>
              <% expenses.forEach(exp => { %>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <%= exp.name %> <span><%= exp.amount %> $</span>
                </li>
              <% }) %>
            <% } else { %>
              <li class="list-group-item">Nema unetih rashoda.</li>
            <% } %>
          </ul>

          <!-- Novi rashod -->
          <form action="/add" method="POST">
            <input name="name" type="text" placeholder="Naziv rashoda" class="form-control mb-2" required>
            <input name="amount" type="number" step="0.01" placeholder="Iznos" class="form-control mb-2" required>
            <button class="btn-create-goal w-100" type="submit">
              <i class="fas fa-plus-circle me-1"></i> Dodaj novi rashod
            </button>
          </form>
        </div>
      </div>

    </div>
  </div>

  <%- include("./partials/footer.ejs") %>

  <!-- JS -->
  <script>
    // Preporučeni dnevni iznos štednje
    const form = document.getElementById('monthlyIncomeForm');
    const incomeInput = document.getElementById('monthlyIncome');
    const recommended = document.getElementById('recommendedSavings');

    form.addEventListener('submit', function (e) {
      e.preventDefault();
      const income = parseFloat(incomeInput.value);
      if (!isNaN(income) && income > 0) {
        const dailySavings = (income * 0.005).toFixed(2);
        recommended.textContent = `Preporučeni iznos za dnevnu štednju: ${dailySavings} $`;
      } else {
        recommended.textContent = '';
      }
    });
  </script>

  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</body>
</html>
