<!DOCTYPE html>
<html lang="en">
<%- include("./partials/head.ejs") %>

  <body>
    <%- include("./partials/nav.ejs") %>

      <div class="dashboard-container container-fluid py-5">
        <div class="row">
          <!-- Leva kolona -->
          <div class="col-lg-3 mb-4 ">
            <div class="leva_kolona">
              <div class="dashboard-card p-3 mb-3">
                <div class="dashboard-user mb-3">
                  <i class="fas fa-user me-2"></i>
                  <span>Korisnik: <strong>
                      <%= user.username %>
                    </strong></span>
                </div>

                <div class="dashboard-balance-highlight mb-3">
                  <i class="fas fa-wallet me-2"></i>
                  Balans: <span>
                    <%= user.balance %> $
                  </span>
                </div>

                <form action="/logout" method="GET" class="dashboard-logout mb-3">
                  <button type="submit" class="btn-create-goal w-100">
                    <i class="fas fa-sign-out-alt me-1"></i> Izloguj se
                  </button>
                </form>
                <div id="errorBalance" class="text-danger text-center mt-2">
                  <%= error %>
                </div>
              </div>

              <div class="dashboard-card p-3">
                <form action="/changebalance" method="POST"
                  class="dashboard-page__change-balance d-flex flex-wrap gap-2">
                  <input id="balans" name="balans" step="0.01" type="number" placeholder="Iznos" class="form-control"
                    required>
                  <button type="submit" class="btn-create-goal">
                    <i class="fas fa-plus-circle me-1"></i> Dodaj novac
                  </button>
                </form>
              </div>
            </div>


            <div class="form-section zavrseni">
              <h2 class="card-title mt-4">Zavr≈°eni ciljevi</h2>
              <div class="goals-scroll">
                <% if (completedGoals.length===0) { %>
                  <p>Nema zavr≈°enih ciljeva</p>
                  <% } else { %>
                    <% completedGoals.forEach(goal=> { %>
                      <div class="goal-card completed zavrsene">
                        <div class="goal-header d-flex justify-content-between align-items-center">
                          <strong class="goal-name">
                            <%= goal.name %>
                          </strong>
                          <span class="goal-progress-text">
                            <%= goal.target %>‚Ç¨ ‚úÖ
                          </span>
                        </div>
                        <div class="progress mb-1">
                          <div class="progress-bar bg-success" role="progressbar" style="width:100%" aria-valuenow="100"
                            aria-valuemin="0" aria-valuemax="100">100%</div>
                        </div>
                      </div>
                      <% }) %>
                        <% } %>
              </div>
            </div>
          </div>

          <!-- Srednja kolona -->
          <div class="col-lg-5">
            <div class="dashboard-single-goal p-3 bg-dark text-light rounded shadow-sm mb-3 dnevni_cilj">
              <div class="dashboard-goal-info d-flex justify-content-between mb-2">
                <strong><i class="fas fa-bullseye me-2"></i> Dnevni cilj</strong>
                <span>
                  <%= user.daily_saved %> / <%= user.daily_goal %> $
                </span>
              </div>
              <div class="progress mb-2" style="height: 10px;">
                <div class="progress-bar bg-success" role="progressbar"
                  style="width:<%= Math.min((user.daily_saved / user.daily_goal) * 100, 100) %>%"></div>
              </div>
              <form action="/changedailygoal" method="POST"
                class="dashboard-page__change-balance d-flex flex-wrap gap-2 mb-2">
                <input id="dailyGoal" name="dailyGoal" step="0.01" type="number" placeholder="Iznos"
                  class="form-control" required>
                <p id="recommendedSavings" class="text-muted small"></p>
                <button type="submit" class="btn-create-goal">
                  <i class="fas fa-plus-circle me-1"></i> Promeni dnevni cilj
                </button>
              </form>
            </div>

            <h2 class="mb-3">Tvoji ciljevi:</h2>
            <div class="row tvoji_ciljevi">
              <% if (goals.length> 0) { %>
                <% goals.forEach(goal=> { %>
                  <div class="col-md-12 mb-3">
                    <div class="dashboard-single-goal p-3 bg-dark text-light rounded shadow-sm">
                      <div class="dashboard-goal-info d-flex justify-content-between mb-2">
                        <strong><i class="fas fa-bullseye me-2"></i>
                          <%= goal.name %>
                        </strong>
                        <span>
                          <%= goal.current %> / <%= goal.target %> $
                        </span>
                      </div>
                      <div class="progress mb-2" style="height: 10px;">
                        <div class="progress-bar bg-success" role="progressbar"
                          style="width:<%= Math.min((goal.current / goal.target) * 100, 100) %>%"></div>
                      </div>
                      <form action="/addgoalbalance" method="POST" class="dashboard-goal__form d-flex flex-wrap gap-2">
                        <input name="goalbalance" step="0.01" type="number" placeholder="Iznos" class="form-control"
                          required>
                        <input type="hidden" name="goalId" value="<%= goal.id %>">
                        <button type="submit" class="btn-create-goal">
                          <i class="fas fa-plus me-1"></i> Dodaj novac
                        </button>
                      </form>
                    </div>
                  </div>
                  <% }) %>
                    <% } else { %>
                      <p>Nema≈° nijedan cilj trenutno.</p>
                      <% } %>
            </div>

            <form action="/newgoals" method="GET" class="mt-3 novi_cilj">
              <button type="submit" class="btn-create-goal">
                <i class="fas fa-flag me-1"></i> Kreiraj novi cilj
              </button>
            </form>
          </div>

          <!-- Desna kolona -->
          <div class="col-lg-4">
            <div class="dashboard-card p-3 mb-3 prihodi">
              <h3 class="mb-3">Meseƒçni prihod</h3>
              <form id="monthlyIncomeForm" class="mb-3">
                <input id="monthlyIncome" type="number" step="0.01" placeholder="Unesi svoj proseƒçni meseƒçni prihod"
                  class="form-control mb-2">
                <button type="submit" class="btn-create-goal w-100">
                  <i class="fas fa-calculator me-1"></i> Potvrdi
                </button>
              </form>
            </div>

            <div class="dashboard-card p-3 mb-3 rashodi">
              <h3 class="mb-3">Mesecni rashodi</h3>
              <ul id="expensesList" class="list-group mb-3">
                <% if (expenses.length> 0) { %>
                  <% expenses.forEach(exp=> { %>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                      <%= exp.name %> <span>
                          <%= exp.amount %> $
                        </span>
                    </li>
                    <% }) %>
                      <% } else { %>
                        <li class="list-group-item">Nema unetih rashoda.</li>
                        <% } %>
              </ul>

              <form id="addExpenseForm" action="/expenses" method="POST" class="new-expense">
                <input name="name" type="text" placeholder="Naziv rashoda" class="form-control mb-2" required>
                <input name="amount" type="number" step="0.01" placeholder="Iznos" class="form-control mb-2" required>
                <button class="btn-create-goal w-100" type="submit">
                  <i class="fas fa-plus-circle me-1"></i> Dodaj novi rashod
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Tutorijal overlay -->
      <% if (showTutorial) { %>
        <div id="tutorialOverlay" class="tutorial-overlay">
          <div id="tutorialStep" class="tutorial-step">
            <p id="tutorialText"></p>
            <span id="tutorialCounter"></span>
            <div class="tutorial-buttons mt-2">
              <button id="prevStep" class="btn-create-goal">Prethodni</button>
              <button id="nextStep" class="btn-create-goal">Sledeƒái</button>
            </div>
          </div>
        </div>
        <% } %>

          <%- include("./partials/footer.ejs") %>

            <% if (showTutorial) { %>
              <script>
                const steps = [
                  { element: '.leva_kolona', text: 'Ovo je tvoj korisniƒçki panel, ovde vidi≈° svoje ime, balans kao i opciju dodavanja balansa.' },
                  { element: '.zavrseni', text: 'Ovde mozes videti ciljeve koje si zavrsio.' },
                  { element: '.dnevni_cilj', text: 'Ovo je dnevni cilj koji morate u≈°tedeti, kako ne biste izgubili streaküî•.' },
                  { element: '.tvoji_ciljevi', text: 'Ovde mo≈æe≈° videti polje gde ce se nalaziti svi tvoji ciljevi.' },
                  { element: '.novi_cilj', text: 'Ovo je dugme koje pravi novi cilj.' },
                  { element: '.prihodi', text: 'Ovde mo≈æe≈° izraƒçunati koliko ti mi predla≈æemo da ≈°tedi≈° na dnevnom nivou na osnovu meseƒçne zarade.' },
                  { element: '.rashodi', text: 'Ovde mo≈æe≈° videti svoje rashode (gde sve ide tvoj novac osim u ≈°tednju).' }
                ];

                let currentStep = 0;
                const overlay = document.getElementById('tutorialOverlay');
                const tutorialText = document.getElementById('tutorialText');
                const tutorialCounter = document.getElementById('tutorialCounter');
                const prevBtn = document.getElementById('prevStep');
                const nextBtn = document.getElementById('nextStep');

                function showStep(stepIndex) {
                  if (stepIndex < 0 || stepIndex >= steps.length) return;

                  currentStep = stepIndex;
                  const step = steps[stepIndex];
                  const el = document.querySelector(step.element);

                  tutorialText.textContent = step.text;
                  tutorialCounter.textContent = `Korak ${currentStep + 1} od ${steps.length}`;
                  overlay.classList.remove('d-none');

                  el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                  document.querySelectorAll('.tutorial-highlight').forEach(e => e.classList.remove('tutorial-highlight'));
                  el.classList.add('tutorial-highlight');

                  const tutorialBox = document.querySelector('.tutorial-step');
                  const isMobile = window.innerWidth <= 768;

                  if (isMobile) {
                    tutorialBox.style.top = 'auto';
                    tutorialBox.style.left = '50%';
                    tutorialBox.style.bottom = '10px';
                    tutorialBox.style.transform = 'translateX(-50%)';
                  } else {
                    if (currentStep === 3 || currentStep === 4) {
                      tutorialBox.style.top = '5%';
                      tutorialBox.style.left = '50%';
                      tutorialBox.style.transform = 'translate(-50%,0)';
                    } else {
                      tutorialBox.style.top = '50%';
                      tutorialBox.style.left = '50%';
                      tutorialBox.style.transform = 'translate(-50%,-50%)';
                    }
                  }

                  // Dugmad
                  prevBtn.style.display = currentStep === 0 ? 'none' : 'inline-flex';

                  if (currentStep === steps.length - 1) {
                    nextBtn.style.display = 'none';

                    if (!document.getElementById('finishStep')) {
                      const finishBtn = document.createElement('button');
                      finishBtn.id = 'finishStep';
                      finishBtn.className = 'btn-create-goal';
                      finishBtn.textContent = 'Zavr≈°i';
                      finishBtn.style.marginLeft = '5px';

                      finishBtn.addEventListener('click', async () => {
                        try {
                          const res = await fetch('/finish-tutorial', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                          });
                          const data = await res.json();
                          if (data.success) {
                            overlay.classList.add('d-none');
                            el.classList.remove('tutorial-highlight');
                          }
                        } catch (err) {
                          console.error('Gre≈°ka pri zavr≈°etku tutorijala:', err);
                        }
                      });

                      nextBtn.parentNode.appendChild(finishBtn);
                    } else {
                      document.getElementById('finishStep').style.display = 'inline-flex';
                    }
                  } else {
                    nextBtn.style.display = 'inline-flex';
                    if (document.getElementById('finishStep')) {
                      document.getElementById('finishStep').style.display = 'none';
                    }
                  }
                }

                // üö® OVO ostavi van showStep, da se doda samo jednom
                nextBtn.addEventListener('click', () => {
                  if (currentStep < steps.length - 1) showStep(currentStep + 1);
                });

                prevBtn.addEventListener('click', () => {
                  if (currentStep > 0) showStep(currentStep - 1);
                });

                window.addEventListener('load', () => {
                  showStep(0);
                });
              </script>
              <% } %>

                <script>
                  const form = document.getElementById('monthlyIncomeForm');
                  const incomeInput = document.getElementById('monthlyIncome');
                  const recommended = document.getElementById('recommendedSavings');

                  form.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const income = parseFloat(incomeInput.value);
                    if (!isNaN(income) && income > 0) {
                      const dailySavings = (income * 0.005).toFixed(2);
                      recommended.textContent = `Preporuƒçeni iznos za dnevnu ≈°tednju: ${dailySavings} $`;
                    } else {
                      recommended.textContent = '';
                    }
                  });
                </script>

                <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  </body>

</html>