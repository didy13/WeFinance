<!DOCTYPE html>
<html lang="sr">
<%- include("./partials/head.ejs") %>
<body>
<%- include("./partials/nav.ejs") %>

<div class="container py-5">

  <% if (successMessage) { %>
    <div class="alert alert-success mt-2"><%= successMessage %></div>
  <% } %>

  <!-- Naziv i opis grupe -->
  <div class="mb-4">
    <h1 class="mb-2"><%= group.name %></h1>
    <p><strong>Opis:</strong> <%= group.description || "Nema opisa" %></p>
  </div>

  <div class="row">
    <!-- Leva kolona: Članovi i dodavanje člana -->
    <div class="col-lg-6 mb-4">
      <div class="card bg-dark text-light h-100">
        <div class="card-body">
          <h2 class="card-title">Članovi</h2>
          <ul class="list-group list-group-flush mb-3">
            <% members.forEach(member => { %>
              <li class="list-group-item bg-secondary text-light border-0"><%= member.username %></li>
            <% }) %>
          </ul>

          <!-- Dodavanje novog člana -->
          <h3 class="mt-3">Dodaj člana (invite)</h3>
          <form action="/groups/<%= group.id %>/add-member" method="POST" class="d-flex gap-2 flex-wrap">
            <input type="text" name="username" placeholder="Username korisnika" required class="form-control flex-grow-1" style="min-width: 150px;">
            <button type="submit" class="btn btn-primary">Pošalji pozivnicu</button>
          </form>
          <% if (errorAddMember) { %>
            <div class="alert alert-danger mt-2"><%= errorAddMember %></div>
          <% } %>

          <!-- Pozivnice -->
          <h4 class="mt-4">Pozivnice</h4>
          <ul>
            <% invites.forEach(invite => { %>
              <li><%= invite.inviter_name %> vas je pozvao u <%= invite.group_name %></li>
            <% }) %>
          </ul>
        </div>
      </div>
    </div>

    <!-- Desna kolona: Ciljevi -->
    <div class="col-lg-6 mb-4">
      <div class="card bg-dark text-light h-100">
        <div class="card-body">

          <!-- Aktivni ciljevi -->
          <h2 class="card-title">Aktivni ciljevi</h2>
          <% const activeGoals = Array.isArray(goals) ? goals.filter(g => !g.completed) : []; %>
          <% if (activeGoals.length === 0) { %>
            <p>Nema aktivnih ciljeva</p>
          <% } else { %>
            <% activeGoals.forEach(goal => { %>
              <% let amountValue = (amountToAdd && amountToAdd.goalId == goal.id) ? amountToAdd.amount : ''; %>
              <div class="card mb-3 bg-secondary">
                <div class="card-body d-flex justify-content-between align-items-center flex-wrap">
                  <strong class="mb-1"><%= goal.goal_name %></strong>
                  <span><%= goal.current %> / <%= goal.target %>€</span>

                  <!-- Dodavanje novca -->
                  <form action="/groups/<%= group.id %>/add-money/<%= goal.id %>" method="POST" class="d-flex gap-2 flex-wrap mt-2 w-100">
                    <input type="number" name="amount" placeholder="Iznos" min="0" required class="form-control flex-grow-1" style="min-width: 100px;" value="<%= amountValue %>">
                    
                    <% if (errorAddMoney && typeof errorAddMoney === 'object' && amountToAdd && goal.id == amountToAdd.goalId) { %>
                      <input type="hidden" name="confirm" value="1">
                      <button type="submit" class="btn btn-warning">Potvrdi i dodaj</button>
                    <% } else { %>
                      <button type="submit" class="btn btn-success">Dodaj</button>
                    <% } %>
                  </form>

                  <% if (errorAddMoney && typeof errorAddMoney === 'object' && (!amountToAdd || goal.id != amountToAdd.goalId)) { %>
                    <div class="text-warning mt-1"><%= errorAddMoney.message %></div>
                  <% } %>
                </div>
              </div>
            <% }) %>
          <% } %>

          <!-- Completed goals -->
          <h2 class="card-title mt-4">Završeni ciljevi</h2>
          <% const completedGoals = Array.isArray(goals) ? goals.filter(g => g.completed) : []; %>
          <% if (completedGoals.length === 0) { %>
            <p>Nema završених ciljeva</p>
          <% } else { %>
            <ul>
              <% completedGoals.forEach(goal => { %>
                <li><%= goal.goal_name %> (Target: <%= goal.target %>€) ✅</li>
              <% }) %>
            </ul>
          <% } %>

          <!-- Dodavanje novog cilja -->
          <h3 class="mt-3">Dodaj cilj</h3>
          <form action="/groups/<%= group.id %>/add-goal" method="POST" class="d-flex gap-2 flex-wrap">
            <input type="text" name="name" placeholder="Naziv cilja" required class="form-control flex-grow-2" style="min-width: 120px;">
            <input type="number" name="target" placeholder="Target iznos" min="0" required class="form-control flex-grow-1" style="min-width: 100px;">
            <button type="submit" class="btn btn-primary">Dodaj cilj</button>
          </form>
          <% if (errorAddGoal) { %>
            <div class="text-danger mt-2"><%= errorAddGoal %></div>
          <% } %>

        </div>
      </div>
    </div>
  </div>
</div>

<%- include("./partials/footer.ejs") %>
</body>
</html>
