<!DOCTYPE html>
<html lang="sr">
<%- include("./partials/head.ejs") %>
<body>
<%- include("./partials/nav.ejs") %>

<div class="container py-5">

  <% if (successMessage) { %>
    <div class="alert alert-success mt-2"><%= successMessage %></div>
  <% } %>

  <!-- Naslov i opis grupe -->
  <div class="group-header">
    <h1><%= group.name %></h1>
    <p><strong>Opis:</strong> <%= group.description || "Nema opisa" %></p>
  </div>

  <div class="row">
    <!-- Leva kolona: Članovi i dodavanje člana -->
    <div class="col-lg-6 mb-4">
      <div class="card bg-dark text-light h-100">
        <div class="card-body">
          <h2 class="card-title">Članovi</h2>
          <ul class="list-group list-group-flush mb-3">
            <% members.forEach(member => { %>
              <li class="list-group-item bg-secondary text-light border-0"><%= member.username %></li>
            <% }) %>
          </ul>

          <!-- Dodavanje člana -->
          <div class="form-section">
            <h3>Dodaj člana (invite)</h3>
            <form action="/groups/<%= group.id %>/add-member" method="POST" class="d-flex flex-column flex-md-row gap-2">
              <input type="text" name="username" placeholder="Username korisnika" required class="form-control flex-grow-1">
              <button type="submit" class="btn btn-primary">Pošalji pozivnicu</button>
            </form>

            <% if (errorAddMember) { %>
              <div class="text-danger mt-2"><%= errorAddMember %></div>
            <% } %>

            <h4 class="mt-4">Pozivnice</h4>
            <ul>
              <% invites.forEach(invite => { %>
                <li>
                  <strong><%= invite.inviter_name %></strong> je poslao pozivnicu
                  <strong><%= invite.invitee_name %></strong> u grupu
                  <strong><%= invite.group_name %></strong>
                </li>
              <% }) %>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Desna kolona: Ciljevi -->
    <div class="col-lg-6 mb-4">
      <div class="card bg-dark text-light h-100">
        <div class="card-body">

          <!-- Aktivni ciljevi -->
          <div class="form-section">
            <h2 class="card-title">Aktivni ciljevi</h2>
            <div class="goals-scroll mb-3">
              <% const activeGoals = Array.isArray(goals) ? goals.filter(g => !g.completed) : []; %>
              <% if (activeGoals.length === 0) { %>
                <p>Nema aktivnih ciljeva</p>
              <% } else { %>
                <% activeGoals.forEach(goal => { %>
                  <% let amountValue = (amountToAdd && amountToAdd.goalId == goal.id) ? amountToAdd.amount : ''; %>
                  <div class="goal-card mb-3 bg-secondary">
                    <div class="goal-header d-flex justify-content-between align-items-center">
                      <strong class="goal-name"><%= goal.goal_name %></strong>
                      <span class="goal-progress-text"><%= goal.current %> / <%= goal.target %>€</span>
                    </div>
                    <div class="progress mb-2">
                      <% let progressPercent = Math.min(100, Math.floor((goal.current/goal.target)*100)); %>
                      <div class="progress-bar" role="progressbar" style="width: <%= progressPercent %>%;" aria-valuenow="<%= progressPercent %>" aria-valuemin="0" aria-valuemax="100"><%= progressPercent %>%</div>
                    </div>

                    <!-- Dodavanje novca -->
                    <form action="/groups/<%= group.id %>/add-money/<%= goal.id %>" method="POST" class="d-flex gap-2 flex-wrap mt-2 w-100">
                      <input type="number" name="amount" placeholder="Iznos" min="0" required class="form-control flex-grow-1" style="min-width: 100px;" value="<%= amountValue %>">
                      <% if (errorAddMoney && typeof errorAddMoney === 'object' && amountToAdd && goal.id == amountToAdd.goalId) { %>
                        <input type="hidden" name="confirm" value="1">
                        <button type="submit" class="btn btn-warning">Potvrdi i dodaj</button>
                      <% } else { %>
                        <button type="submit" class="btn btn-success">Dodaj</button>
                      <% } %>
                    </form>

                    <% if (errorAddMoney && typeof errorAddMoney === 'object' && (!amountToAdd || goal.id != amountToAdd.goalId)) { %>
                      <div class="text-warning mt-1"><%= errorAddMoney.message %></div>
                    <% } %>
                  </div>
                <% }) %>
              <% } %>
            </div>
          </div>

          <!-- Završeni ciljevi -->
          <div class="form-section">
            <h2 class="card-title mt-4">Završeni ciljevi</h2>
            <% const completedGoals = Array.isArray(goals) ? goals.filter(g => g.completed) : []; %>
            <div class="goals-scroll">
              <% if (completedGoals.length === 0) { %>
                <p>Nema završених ciljeva</p>
              <% } else { %>
                <% completedGoals.forEach(goal => { %>
                  <div class="goal-card completed">
                    <div class="goal-header d-flex justify-content-between align-items-center">
                      <strong class="goal-name"><%= goal.goal_name %></strong>
                      <span class="goal-progress-text"><%= goal.target %>€ ✅</span>
                    </div>
                    <div class="progress mb-1">
                      <div class="progress-bar bg-success" role="progressbar" style="width:100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">100%</div>
                    </div>
                  </div>
                <% }) %>
              <% } %>
            </div>
          </div>

          <!-- Dodavanje cilja -->
          <div class="form-section">
            <h3>Dodaj cilj</h3>
            <form action="/groups/<%= group.id %>/add-goal" method="POST" class="d-flex flex-column flex-md-row gap-2">
              <input type="text" name="name" placeholder="Naziv cilja" required class="form-control flex-grow-2">
              <input type="number" name="target" placeholder="Target iznos" min="0" required class="form-control flex-grow-1">
              <button type="submit" class="btn btn-primary">Dodaj cilj</button>
            </form>
            <% if (errorAddGoal) { %>
              <div class="text-danger mt-2"><%= errorAddGoal %></div>
            <% } %>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<%- include("./partials/footer.ejs") %>
</body>
</html>
